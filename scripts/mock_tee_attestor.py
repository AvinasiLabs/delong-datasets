#!/usr/bin/env python3
"""
Mock TEE attestor service - simulates the local UNIX socket service.

In a real TEE environment, this service runs as a daemon and provides
attestation tokens via UNIX socket at /var/run/delong-attestor/socket.

For testing, you can:
1. Run this as an HTTP service (easier)
2. OR run as UNIX socket server (more realistic)
"""
import argparse
import json
import os
import socket
import sys
from http.server import BaseHTTPRequestHandler, HTTPServer
from pathlib import Path


# Mock attestation token - in production this would be generated by TEE hardware
MOCK_ATTESTATION_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.mock_tee_attestation_token"


class AttestorHTTPHandler(BaseHTTPRequestHandler):
    """HTTP handler for attestor service."""

    def do_POST(self):
        """Handle POST /token request."""
        if self.path != "/token":
            self.send_error(404)
            return

        # Read request body
        content_length = int(self.headers.get("Content-Length", 0))
        body = self.rfile.read(content_length)

        try:
            request = json.loads(body)
            audience = request.get("audience", "")

            # Generate mock token
            response = {"token": MOCK_ATTESTATION_TOKEN}

            # Send response
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            self.wfile.write(json.dumps(response).encode())

            print(f"✓ Issued attestation token for audience: {audience}")

        except Exception as e:
            self.send_error(500, str(e))

    def log_message(self, format, *args):
        """Suppress default logging."""
        pass


def run_http_server(port: int):
    """Run as HTTP server (easier for testing)."""
    server = HTTPServer(("localhost", port), AttestorHTTPHandler)
    print(f"Mock TEE Attestor running on http://localhost:{port}")
    print("Endpoint: POST /token")
    print("Press Ctrl+C to stop")
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print("\nShutting down...")
        server.shutdown()


def run_unix_socket_server(socket_path: str):
    """Run as UNIX socket server (more realistic)."""
    # Remove existing socket
    if os.path.exists(socket_path):
        os.remove(socket_path)

    # Create socket directory if needed
    socket_dir = os.path.dirname(socket_path)
    if socket_dir:
        Path(socket_dir).mkdir(parents=True, exist_ok=True)

    # Create UNIX socket
    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    sock.bind(socket_path)
    sock.listen(1)

    print(f"Mock TEE Attestor running on UNIX socket: {socket_path}")
    print("Press Ctrl+C to stop")

    try:
        while True:
            conn, _ = sock.accept()
            try:
                # Read HTTP request
                data = b""
                while b"\r\n\r\n" not in data:
                    chunk = conn.recv(4096)
                    if not chunk:
                        break
                    data += chunk

                # Parse request
                header, body = data.split(b"\r\n\r\n", 1)
                if body:
                    request = json.loads(body.decode())
                    audience = request.get("audience", "")
                else:
                    audience = ""

                # Generate response
                response_body = json.dumps({"token": MOCK_ATTESTATION_TOKEN})
                http_response = (
                    f"HTTP/1.1 200 OK\r\n"
                    f"Content-Type: application/json\r\n"
                    f"Content-Length: {len(response_body)}\r\n"
                    f"\r\n"
                    f"{response_body}"
                )

                conn.sendall(http_response.encode())
                print(f"✓ Issued attestation token for audience: {audience}")

            finally:
                conn.close()

    except KeyboardInterrupt:
        print("\nShutting down...")
    finally:
        sock.close()
        if os.path.exists(socket_path):
            os.remove(socket_path)


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(description="Mock TEE Attestor Service")
    parser.add_argument(
        "--mode",
        choices=["http", "unix"],
        default="http",
        help="Server mode: http (easier) or unix (realistic)",
    )
    parser.add_argument("--port", type=int, default=8002, help="HTTP port (if mode=http)")
    parser.add_argument(
        "--socket",
        default="/tmp/delong-attestor.sock",
        help="UNIX socket path (if mode=unix)",
    )

    args = parser.parse_args()

    if args.mode == "http":
        run_http_server(args.port)
    else:
        run_unix_socket_server(args.socket)


if __name__ == "__main__":
    main()
